  - name: Deply a web application
    hosts: all
    vars:
      db_name: employee_db
      db_user: db_user
      db_password: Passw0rd
    tasks:
      - name: Install all required dependencies
        action: >
          {{ ansible_pkg_mgr }} name={{ item }} state=present update_cache=yes
        with_items:
          - python
          - python-setuptools
          - python-dev
          - build-essential
          - python-pip
          - python-mysqldb

      - name: Install MySQL
        action: >
          {{ ansible_pkg_mgr }} name={{ item }} state=present update_cache=yes
        with_items:
          - mysql-server
          - mysql-client

      - name: Start MySQL Server
        service: name=mysql state=started enabled=yes

      - name: Create Application Database
        mysql_db: name="{{ db_name}}" state=present

      - name: Create Database User
        mysql_user:
          name: "{{ db_user }}"
          password: "{{ db_password }}"
          priv: '*.*:ALL'
          state: present
          host: '%'

      - name: Install Flask and Flask Dependency
        action: >
          pip name={{ item }} state=present
        with_items:
          - flask
          - flask-mysql

      - name: Copy the source code
        copy: src=app.py dest=/opt/app.py

      - name: Start Web Server
        shell: FLASK_APP=/opt/app.py nohup flask run --host=0.0.0.0 &